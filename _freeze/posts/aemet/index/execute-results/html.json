{
  "hash": "d77b53f651a322813d02438f54263fd0",
  "result": {
    "markdown": "---\ntitle: \"Handle climatic data using AEMET API\"\nauthor: \"Adrian Manzanal\"\ndate: \"2023-11-23\"\ncategories: [news, AEMET]\nimage: \"climaemet.jpg\"\n---\n\n\n# **Start to download historical data and 4 days forecast.**\n**Quick weather information**\n\nThe goal of climaemet is to serve as an interface to download the climatic data of the Spanish Meteorological Agency (AEMET) directly from R using their API and create scientific graphs (climate charts, trend analysis of climate time series, temperature and precipitation anomalies maps, “warming stripes” graphics, climatograms, etc.).\n\nBrowse manual and vignettes at https://ropenspain.github.io/climaemet/.\n\n### 1. climaemet library and registration\n\nYou can install the released version of climaemet from CRAN with:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"climaemet\", dependencies = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(climaemet)\n```\n:::\n\n\nAfter install the package you have to register in the following URL in order to get the API key. Once\nyou receive your ID key you have sig in using the following function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbrowseURL(\"https://opendata.aemet.es/centrodedescargas/obtencionAPIKey\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nOnce you receive your ID key you have to sig in using the following function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\naemet_api_key(\"YOUR ID KEY\", install = TRUE, overwrite = TRUE)\n```\n:::\n\n\nIt would be useful to prepare these library for next steps..\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(broom)\nlibrary(mapSpain)\nlibrary(ggmap)\nlibrary(sf)\nlibrary(ggplot2)\n```\n:::\n\n\n### 2. Historical data by weather station\n\nAemet database contains historical weather data from 291 stations:\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nIn order to see stations we are going to download the relation table which contains all of them and the ID:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstations <- aemet_stations() \nhead(stations)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 7\n  indicativo indsinop nombre               provincia altitud longitud latitud\n  <chr>      <chr>    <chr>                <chr>       <dbl>    <dbl>   <dbl>\n1 0252D      \"08186\"  ARENYS DE MAR        BARCELONA      74     2.54    41.6\n2 0076       \"08181\"  BARCELONA AEROPUERTO BARCELONA       4     2.07    41.3\n3 0200E      \"\"       BARCELONA, FABRA     BARCELONA     408     2.12    41.4\n4 0201D      \"08180\"  BARCELONA            BARCELONA       6     2.2     41.4\n5 0149X      \"08174\"  MANRESA              BARCELONA     291     1.84    41.7\n6 0229I      \"08192\"  SABADELL AEROPUERTO  BARCELONA     146     2.10    41.5\n```\n:::\n:::\n\n\nSelect the station that you want to analyze\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation <- \"2661\" # Leon\n```\n:::\n\n\nNow we are going to download daily climatic data for this station between 2012 and 2023 using the following function: \"aemet_daily_clim\". This dataset contains multiple clima variables. We are interested on temperatures (average, minimal and max.). After filtrating teperatures we should convert to longer format help us to create time series charts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleon_2023 <-\n  aemet_daily_clim(station, start = \"2012-01-01\", end = \"2023-11-30\") %>% \n  select(fecha, tmed, tmax, tmin) |> \n  pivot_longer(cols=c(\"tmed\", \"tmax\", \"tmin\"),\n               names_to= \"variable\",\n               values_to=\"temp\")\n```\n:::\n\n\nUsing \"leon_2023\" object, we can create the chart which contains daily historic temperatures in Leon:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(leon_2023, aes(x = fecha, y = temp, group = variable, color = variable)) +\n  geom_line(linewidth = 0.2) +\n  scale_y_continuous(\n    labels = scales::label_comma(suffix = \"º\")) +\n  scale_color_manual(values = c(\"#EE9322\",\"grey\",\"#78D6C6\"), \n                     name = \"Temperature\") +\n  theme_minimal()+\n  labs(title = \"Leon\",\n       subtitle = \"Daily Temperatures, 2012-2023\",\n       x = \"\", y =\"\") +\n  theme(\n    legend.position = \"top\",\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    plot.title = element_text(size = 28, face = \"bold\", family = \"serif\", hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5, size = 19),\n    axis.text = element_text(size = 16),\n    legend.text = element_text(size = 18)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### 3.Clima Forecast\n\nIf you are interested to know Aemet forecast, using \"aemet_forecast_daily\" you will be able to download clima variables by county.\n\nusing aemet_munic we are going to create an array which contains countys IDs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvarios_munis <- aemet_munic  %>% \n  filter(municipio_nombre %in% c(\"Loeches\", \"León\", \"Potes\", \"Gandia\"))  %>%    \n  pull(municipio)\n\ndaily <- aemet_forecast_daily(varios_munis)\n```\n:::\n\n\nTo review available variables\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naemet_forecast_vars_available(daily)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"probPrecipitacion\" \"cotaNieveProv\"     \"estadoCielo\"      \n[4] \"viento\"            \"rachaMax\"          \"temperatura\"      \n[7] \"sensTermica\"       \"humedadRelativa\"  \n```\n:::\n:::\n\n\nNow lets select those variable that we are interested on. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp_diaria <- aemet_forecast_tidy(daily, \"temperatura\")\n\n\ntemp_diaria_limpio <- temp_diaria  |> \n  select(\n    elaborado, fecha, municipio, nombre, temperatura_minima,\n    temperatura_maxima\n  )  |> \n  tidyr::pivot_longer(cols = contains(\"temperatura\"))\n```\n:::\n\n\nTime to chartering\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(temp_diaria_limpio) +\n  geom_line(aes(fecha, value, color = name), linewidth = 1) +\n  geom_point(aes(fecha, value, color = name), size = 1.9) +\n  facet_wrap(~nombre, ncol = 2) +   # que haga un gráfico para cada municipio\n  scale_color_manual(\n    values = c(\"#EE9322\", \"#78D6C6\"),\n    labels = c(\"max\", \"min\")\n  ) +\n  scale_x_date(\n    labels = scales::label_date_short(),\n    breaks = \"day\"\n  ) +\n  scale_y_continuous(\n    labels = scales::label_comma(suffix = \"º\"),\n    limits = c(0,30)\n  ) +\n  theme_minimal() +\n  labs(\n    x = \"\", y = \"\",\n    color = \"\",\n    title = \"Some Countys\",\n    subtitle = \"Temperatures forecast for next 7 days\",\n    caption = paste(\n      \"Created \",\n      format(temp_diaria_limpio$elaborado[1], usetz = TRUE)\n    )\n  )  +\n  theme(\n    legend.position = \"top\",\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    plot.title = element_text(size = 28, face = \"bold\", family = \"serif\", hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5, size = 19),\n    axis.text = element_text(size = 16),\n    legend.text = element_text(size = 18),\n    strip.text = element_text(size = 18)\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 12 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nFull site with more examples and vignettes on https://ropenspain.github.io/climaemet/\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}